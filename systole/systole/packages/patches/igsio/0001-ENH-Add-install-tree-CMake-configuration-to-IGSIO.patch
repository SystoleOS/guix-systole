From 32c4156034981389f484f1185c45d59a62c72570 Mon Sep 17 00:00:00 2001
From: Rafael Palomar <rafael.palomar@ous-research.no>
Date: Fri, 27 Feb 2026 12:05:21 +0100
Subject: [PATCH] ENH: Add install-tree CMake configuration to IGSIO

Add install(EXPORT IGSIO ...) rules to IGSIOCommon, SequenceIO, and
VolumeReconstruction (using the same EXPORT IGSIO name already used by
IGSIOCalibration via IGSIOInstallLibrary), install public headers for
each module to include/IGSIO-1.0/, and add an install-tree config file
(IGSIOInstallConfig.cmake.in) that sets VTKIGSIO*_INCLUDE_DIRS to the
installed prefix so downstream packages can use find_package(IGSIO)
against the Guix store path.
---
 CMake/IGSIOInstallConfig.cmake.in   | 26 ++++++++++++++++++++++++++
 CMakeLists.txt                      | 21 +++++++++++++++++++++
 IGSIOCommon/CMakeLists.txt          |  6 +++++-
 SequenceIO/CMakeLists.txt           |  6 +++++-
 VolumeReconstruction/CMakeLists.txt |  6 +++++-
 5 files changed, 62 insertions(+), 3 deletions(-)
 create mode 100644 CMake/IGSIOInstallConfig.cmake.in

diff --git a/CMake/IGSIOInstallConfig.cmake.in b/CMake/IGSIOInstallConfig.cmake.in
new file mode 100644
index 0000000..5814ced
--- /dev/null
+++ b/CMake/IGSIOInstallConfig.cmake.in
@@ -0,0 +1,26 @@
+#-----------------------------------------------------------------------------
+#
+# IGSIOConfig.cmake — IGSIO CMake configuration file for install-tree use.
+#
+# Compute the installation prefix from this file's location:
+#   <prefix>/lib/cmake/IGSIO/IGSIOConfig.cmake  →  <prefix>
+get_filename_component(_IGSIO_PREFIX "${CMAKE_CURRENT_LIST_FILE}" PATH)
+get_filename_component(_IGSIO_PREFIX "${_IGSIO_PREFIX}" PATH)
+get_filename_component(_IGSIO_PREFIX "${_IGSIO_PREFIX}" PATH)
+
+# Include directories for each IGSIO component (all headers are installed
+# flat into include/@IGSIO_INSTALL_FOLDERNAME@/).
+set(VTKIGSIOCOMMON_INCLUDE_DIRS
+  "${_IGSIO_PREFIX}/include/@IGSIO_INSTALL_FOLDERNAME@")
+set(VTKSEQUENCEIO_INCLUDE_DIRS
+  "${_IGSIO_PREFIX}/include/@IGSIO_INSTALL_FOLDERNAME@")
+set(VTKVOLUMERECONSTRUCTION_INCLUDE_DIRS
+  "${_IGSIO_PREFIX}/include/@IGSIO_INSTALL_FOLDERNAME@")
+set(VTKIGSIOCALIBRATION_INCLUDE_DIRS
+  "${_IGSIO_PREFIX}/include/@IGSIO_INSTALL_FOLDERNAME@")
+
+set(IGSIO_BUILD_SEQUENCEIO           "@IGSIO_BUILD_SEQUENCEIO@")
+set(IGSIO_BUILD_VOLUMERECONSTRUCTION "@IGSIO_BUILD_VOLUMERECONSTRUCTION@")
+
+# Import the exported targets.
+include("${CMAKE_CURRENT_LIST_DIR}/IGSIOTargets.cmake")
diff --git a/CMakeLists.txt b/CMakeLists.txt
index bfb00a1..e7cea91 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -189,4 +189,25 @@ else()
   list(APPEND IGSIO_INSTALL_CMAKE_FILES} "${CMAKE_CURRENT_BINARY_DIR}/IGSIOConfigVersion.cmake")
   include(${CMAKE_SOURCE_DIR}/CMake/GenerateIGSIOConfig.cmake)
 
+  # Install all IGSIO targets from the install tree.
+  install(EXPORT IGSIO
+    DESTINATION lib/cmake/IGSIO
+    FILE IGSIOTargets.cmake
+    COMPONENT Development)
+
+  # Install the install-tree config and version files.
+  configure_file(
+    ${CMAKE_SOURCE_DIR}/CMake/IGSIOInstallConfig.cmake.in
+    ${CMAKE_CURRENT_BINARY_DIR}/IGSIOConfig.cmake.install
+    @ONLY)
+  install(FILES
+    ${CMAKE_CURRENT_BINARY_DIR}/IGSIOConfig.cmake.install
+    DESTINATION lib/cmake/IGSIO
+    RENAME IGSIOConfig.cmake
+    COMPONENT Development)
+  install(FILES
+    ${CMAKE_CURRENT_BINARY_DIR}/IGSIOConfigVersion.cmake
+    DESTINATION lib/cmake/IGSIO
+    COMPONENT Development)
+
 endif()
diff --git a/IGSIOCommon/CMakeLists.txt b/IGSIOCommon/CMakeLists.txt
index 8613793..b3a1a85 100644
--- a/IGSIOCommon/CMakeLists.txt
+++ b/IGSIOCommon/CMakeLists.txt
@@ -96,10 +96,14 @@ target_link_libraries(${PROJECT_NAME}
   PRIVATE ${${PROJECT_NAME}_LIBS_PRIVATE}
   )
 
-install(TARGETS ${PROJECT_NAME} EXPORT ${PROJECT_NAME}
+install(TARGETS ${PROJECT_NAME} EXPORT IGSIO
   RUNTIME DESTINATION ${IGSIO_INSTALL_BIN_DIR} COMPONENT RuntimeLibraries
   LIBRARY DESTINATION ${IGSIO_INSTALL_LIB_DIR} COMPONENT RuntimeLibraries
   ARCHIVE DESTINATION ${IGSIO_INSTALL_LIB_DIR} COMPONENT Development)
+install(FILES ${${PROJECT_NAME}_HDRS}
+  DESTINATION ${IGSIO_INCLUDE_INSTALL} COMPONENT Development)
+install(FILES ${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}_export.h
+  DESTINATION ${IGSIO_INCLUDE_INSTALL} COMPONENT Development)
 
 foreach(p IN LISTS ${PROJECT_NAME}_INCLUDE_DIRS)
   target_include_directories(${PROJECT_NAME} PUBLIC $<BUILD_INTERFACE:${p}>)
diff --git a/SequenceIO/CMakeLists.txt b/SequenceIO/CMakeLists.txt
index d0606d3..814782b 100644
--- a/SequenceIO/CMakeLists.txt
+++ b/SequenceIO/CMakeLists.txt
@@ -79,10 +79,14 @@ target_link_libraries(${PROJECT_NAME}
   PRIVATE ${${PROJECT_NAME}_LIBS_PRIVATE}
   )
 
-install(TARGETS ${PROJECT_NAME} EXPORT ${PROJECT_NAME}
+install(TARGETS ${PROJECT_NAME} EXPORT IGSIO
   RUNTIME DESTINATION ${IGSIO_INSTALL_BIN_DIR} COMPONENT RuntimeLibraries
   LIBRARY DESTINATION ${IGSIO_INSTALL_LIB_DIR} COMPONENT RuntimeLibraries
   ARCHIVE DESTINATION ${IGSIO_INSTALL_LIB_DIR} COMPONENT Development)
+install(FILES ${${PROJECT_NAME}_HDRS}
+  DESTINATION ${IGSIO_INCLUDE_INSTALL} COMPONENT Development)
+install(FILES ${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}_export.h
+  DESTINATION ${IGSIO_INCLUDE_INSTALL} COMPONENT Development)
 
 foreach(p IN LISTS ${PROJECT_NAME}_INCLUDE_DIRS)
   target_include_directories(${PROJECT_NAME} PUBLIC $<BUILD_INTERFACE:${p}>)
diff --git a/VolumeReconstruction/CMakeLists.txt b/VolumeReconstruction/CMakeLists.txt
index 95aa88b..4e8a3c5 100644
--- a/VolumeReconstruction/CMakeLists.txt
+++ b/VolumeReconstruction/CMakeLists.txt
@@ -61,10 +61,14 @@ target_link_libraries(${PROJECT_NAME}
   PRIVATE ${${PROJECT_NAME}_LIBS_PRIVATE}
   )
 
-install(TARGETS ${PROJECT_NAME} EXPORT ${PROJECT_NAME}
+install(TARGETS ${PROJECT_NAME} EXPORT IGSIO
   RUNTIME DESTINATION ${IGSIO_INSTALL_BIN_DIR} COMPONENT RuntimeLibraries
   LIBRARY DESTINATION ${IGSIO_INSTALL_LIB_DIR} COMPONENT RuntimeLibraries
   ARCHIVE DESTINATION ${IGSIO_INSTALL_LIB_DIR} COMPONENT Development)
+install(FILES ${${PROJECT_NAME}_HDRS}
+  DESTINATION ${IGSIO_INCLUDE_INSTALL} COMPONENT Development)
+install(FILES ${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}_export.h
+  DESTINATION ${IGSIO_INCLUDE_INSTALL} COMPONENT Development)
 
 GENERATE_EXPORT_HEADER(${PROJECT_NAME})
 set_property(GLOBAL APPEND PROPERTY IGSIO_TARGETS ${PROJECT_NAME})
-- 
2.52.0

