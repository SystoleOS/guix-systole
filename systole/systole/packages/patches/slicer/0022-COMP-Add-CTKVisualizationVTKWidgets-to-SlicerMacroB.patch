From e13196496ba646beb066fd6f982a23f7e1f2cc58 Mon Sep 17 00:00:00 2001
From: Rafael Palomar <rafael.palomar@ous-research.no>
Date: Fri, 20 Feb 2026 23:13:04 +0100
Subject: [PATCH] COMP: Add CTKVisualizationVTKWidgets to
 SlicerMacroBuildModuleQtLibrary

CTKVisualizationVTKWidgets carries INTERFACE_COMPILE_DEFINITIONS for
CTK_USE_QVTKOPENGLWIDGET and CTK_HAS_QVTKOPENGLNATIVEWIDGET_H via
CTKExports.cmake.  Without linking this target those definitions are
absent, causing CTK headers (e.g. ctkVTKAbstractView.h) to fall back to
including the legacy QVTKWidget.h which was removed in VTK 9.x.

UseSlicer.cmake already calls find_package(CTK) so the IMPORTED target
is available; add it alongside Qt5::Widgets and Qt5::Xml so that all
callers of SlicerMacroBuildModuleQtLibrary get the correct definitions.
---
 CMake/SlicerMacroBuildModuleQtLibrary.cmake | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/CMake/SlicerMacroBuildModuleQtLibrary.cmake b/CMake/SlicerMacroBuildModuleQtLibrary.cmake
index 192b99be82..ed4d7b4e2e 100644
--- a/CMake/SlicerMacroBuildModuleQtLibrary.cmake
+++ b/CMake/SlicerMacroBuildModuleQtLibrary.cmake
@@ -67,15 +67,21 @@ macro(SlicerMacroBuildModuleQtLibrary)
   # --------------------------------------------------------------------------
   set(lib_name ${MODULEQTLIBRARY_NAME})
 
-  # Qt-based module libraries always need Qt5::Widgets and Qt5::Xml.
-  # Linking these targets propagates Qt5 include directories automatically,
-  # which is needed when building against an installed (non-superbuild) Slicer
-  # where Qt5 headers are not part of any Slicer_*_INCLUDE_DIRS variable.
+  # Qt-based module libraries always need Qt5::Widgets, Qt5::Xml, and
+  # CTKVisualizationVTKWidgets. Linking these targets propagates include
+  # directories and compile definitions automatically, which is needed when
+  # building against an installed (non-superbuild) Slicer where Qt5 headers
+  # are not part of any Slicer_*_INCLUDE_DIRS variable.
   # Qt5::Xml is required because CTK headers (e.g. ctkLayoutManager.h) include
   # QDomDocument which lives in the QtXml module.
+  # CTKVisualizationVTKWidgets is required to propagate CTK_USE_QVTKOPENGLWIDGET
+  # and CTK_HAS_QVTKOPENGLNATIVEWIDGET_H compile definitions so that CTK headers
+  # (e.g. ctkVTKAbstractView.h) select the correct VTK OpenGL widget path
+  # instead of falling back to the removed QVTKWidget.h.
   list(APPEND MODULEQTLIBRARY_TARGET_LIBRARIES
     Qt5::Widgets
     Qt5::Xml
+    CTKVisualizationVTKWidgets
     )
 
   # When building against an installed (non-superbuild) Slicer, headers and
-- 
2.52.0

