From a3b4df470e9b172c775dc10b9b5f68e18cd2cebe Mon Sep 17 00:00:00 2001
From: Rafael Palomar <rafael.palomar@ous-research.no>
Date: Tue, 24 Feb 2026 09:49:25 +0100
Subject: [PATCH] COMP: Fix Slicer_BINARY_DIR usage in SubjectHierarchyPlugins
 for standalone builds

SubjectHierarchyPlugins/CMakeLists.txt used ${Slicer_BINARY_DIR} as the
base for its ctkMacroCompilePythonScript DESTINATION_DIR.  In an install-
tree standalone build, Slicer_BINARY_DIR is empty (it is Slicer's own build
directory, not available outside a Slicer superbuild), so the destination
collapsed to "/lib/Slicer-5.8/qt-scripted-modules/SubjectHierarchyPlugins"
(an absolute path at the filesystem root) and the copy step failed in the
Guix sandbox.

Replace ${Slicer_BINARY_DIR}/ with ${CMAKE_BINARY_DIR}/ so the compiled
Python scripts are placed under the current project's binary tree instead
of Slicer's.  When building inside a Slicer superbuild CMAKE_BINARY_DIR
equals Slicer_BINARY_DIR, so the existing behaviour is preserved.

Also add file(MAKE_DIRECTORY ...) before ctkMacroCompilePythonScript to
ensure the destination directory exists at configure time.  CTK's macro
calls get_filename_component(... REALPATH) which on Linux calls realpath();
realpath() requires all path components to exist, so pre-creating the
directory prevents it from failing or returning an unexpected path.
---
 .../Widgets/Python/SubjectHierarchyPlugins/CMakeLists.txt  | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/Modules/Loadable/SubjectHierarchy/Widgets/Python/SubjectHierarchyPlugins/CMakeLists.txt b/Modules/Loadable/SubjectHierarchy/Widgets/Python/SubjectHierarchyPlugins/CMakeLists.txt
index 9902de240e..2f1607edd6 100644
--- a/Modules/Loadable/SubjectHierarchy/Widgets/Python/SubjectHierarchyPlugins/CMakeLists.txt
+++ b/Modules/Loadable/SubjectHierarchy/Widgets/Python/SubjectHierarchyPlugins/CMakeLists.txt
@@ -9,11 +9,16 @@ set(SubjectHierarchyPlugins_PYTHON_SCRIPTS
 set(SubjectHierarchyPlugins_PYTHON_RESOURCES
   )
 
+# Ensure the destination directory exists at configure time so that
+# ctkMacroCompilePythonScript's get_filename_component(... REALPATH) call
+# can resolve the path correctly (realpath() requires existing dirs on Linux).
+file(MAKE_DIRECTORY "${CMAKE_BINARY_DIR}/${Slicer_QTSCRIPTEDMODULES_LIB_DIR}/SubjectHierarchyPlugins")
+
 ctkMacroCompilePythonScript(
   TARGET_NAME ${MODULE_NAME}SubjectHierarchyPlugins
   SCRIPTS "${SubjectHierarchyPlugins_PYTHON_SCRIPTS}"
   RESOURCES "${SubjectHierarchyPlugins_PYTHON_RESOURCES}"
-  DESTINATION_DIR ${Slicer_BINARY_DIR}/${Slicer_QTSCRIPTEDMODULES_LIB_DIR}/SubjectHierarchyPlugins
+  DESTINATION_DIR ${CMAKE_BINARY_DIR}/${Slicer_QTSCRIPTEDMODULES_LIB_DIR}/SubjectHierarchyPlugins
   INSTALL_DIR ${Slicer_INSTALL_QTSCRIPTEDMODULES_LIB_DIR}/SubjectHierarchyPlugins
   NO_INSTALL_SUBDIR
   )
-- 
2.52.0

