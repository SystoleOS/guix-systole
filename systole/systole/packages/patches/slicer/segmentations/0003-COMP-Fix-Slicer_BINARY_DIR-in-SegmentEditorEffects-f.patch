From c4219a0b308ccbf04d3537bbf8e62a968b7e799a Mon Sep 17 00:00:00 2001
From: Rafael Palomar <rafael.palomar@ous-research.no>
Date: Tue, 24 Feb 2026 13:29:44 +0100
Subject: [PATCH] COMP: Fix Slicer_BINARY_DIR in SegmentEditorEffects for
 standalone builds

SegmentEditorEffects/CMakeLists.txt used \${Slicer_BINARY_DIR} as the
base for its ctkMacroCompilePythonScript DESTINATION_DIR.  In an install-
tree standalone build, Slicer_BINARY_DIR is empty (it is Slicer's own
build directory, not available outside a Slicer superbuild), so the
destination collapsed to "/lib/Slicer-5.8/qt-scripted-modules/..."
(an absolute path at the filesystem root) and the copy step failed in
the Guix sandbox.

Replace \${Slicer_BINARY_DIR}/ with \${CMAKE_BINARY_DIR}/ so the compiled
Python scripts are placed under the current project's binary tree.  When
building inside a Slicer superbuild CMAKE_BINARY_DIR equals Slicer_BINARY_DIR,
so the existing behaviour is preserved.

Also add file(MAKE_DIRECTORY ...) before ctkMacroCompilePythonScript to
ensure the destination directory exists at configure time.  CTK's macro
calls get_filename_component(... REALPATH) which on Linux calls realpath();
realpath() requires all path components to exist.
---
 .../Python/SegmentEditorEffects/CMakeLists.txt             | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/Modules/Loadable/Segmentations/EditorEffects/Python/SegmentEditorEffects/CMakeLists.txt b/Modules/Loadable/Segmentations/EditorEffects/Python/SegmentEditorEffects/CMakeLists.txt
index fd345eacd4..bbdfdf5407 100644
--- a/Modules/Loadable/Segmentations/EditorEffects/Python/SegmentEditorEffects/CMakeLists.txt
+++ b/Modules/Loadable/Segmentations/EditorEffects/Python/SegmentEditorEffects/CMakeLists.txt
@@ -32,11 +32,16 @@ set(SegmentEditorEffects_PYTHON_RESOURCES
   Resources/Icons/Threshold.png
   )
 
+# Ensure the destination directory exists at configure time so that
+# ctkMacroCompilePythonScript's get_filename_component(... REALPATH) call
+# can resolve the path correctly (realpath() requires existing dirs on Linux).
+file(MAKE_DIRECTORY "${CMAKE_BINARY_DIR}/${Slicer_QTSCRIPTEDMODULES_LIB_DIR}/SegmentEditorEffects")
+
 ctkMacroCompilePythonScript(
   TARGET_NAME SegmentEditorEffects
   SCRIPTS "${SegmentEditorEffects_PYTHON_SCRIPTS}"
   RESOURCES "${SegmentEditorEffects_PYTHON_RESOURCES}"
-  DESTINATION_DIR ${Slicer_BINARY_DIR}/${Slicer_QTSCRIPTEDMODULES_LIB_DIR}/SegmentEditorEffects
+  DESTINATION_DIR ${CMAKE_BINARY_DIR}/${Slicer_QTSCRIPTEDMODULES_LIB_DIR}/SegmentEditorEffects
   INSTALL_DIR ${Slicer_INSTALL_QTSCRIPTEDMODULES_LIB_DIR}/SegmentEditorEffects
   NO_INSTALL_SUBDIR
   )
-- 
2.52.0

