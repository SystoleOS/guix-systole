From 73046406f88270bb9a87fb93c472bcaee667f69f Mon Sep 17 00:00:00 2001
From: Rafael Palomar <rafael.palomar@ous-research.no>
Date: Fri, 20 Feb 2026 16:10:14 +0100
Subject: [PATCH 3/3] ENH: add Qt5 and loadable modules includes for
 non-superbuild

Ensure Qt5::Widgets is linked to propagate Qt include directories and add
installed qt-loadable-modules include path when building against an
installed (non-superbuild) Slicer.
---
 CMake/SlicerMacroBuildModuleQtLibrary.cmake | 20 ++++++++++++++++++++
 1 file changed, 20 insertions(+)

diff --git a/CMake/SlicerMacroBuildModuleQtLibrary.cmake b/CMake/SlicerMacroBuildModuleQtLibrary.cmake
index 8671c1dfcb..05dcdae756 100644
--- a/CMake/SlicerMacroBuildModuleQtLibrary.cmake
+++ b/CMake/SlicerMacroBuildModuleQtLibrary.cmake
@@ -67,6 +67,26 @@ macro(SlicerMacroBuildModuleQtLibrary)
   # --------------------------------------------------------------------------
   set(lib_name ${MODULEQTLIBRARY_NAME})
 
+  # Qt-based module libraries always need Qt5::Widgets. Linking the target
+  # propagates Qt5 include directories automatically, which is needed when
+  # building against an installed (non-superbuild) Slicer where Qt5 headers
+  # are not part of any Slicer_*_INCLUDE_DIRS variable.
+  list(APPEND MODULEQTLIBRARY_TARGET_LIBRARIES
+    Qt5::Widgets
+    )
+
+  # When building against an installed (non-superbuild) Slicer, headers from
+  # installed qt-loadable modules (e.g. qSlicerSubjectHierarchyAbstractPlugin.h)
+  # are not covered by any Slicer_*_INCLUDE_DIRS variable. Add the installed
+  # qt-loadable-modules include tree so they are found.
+  if(NOT Slicer_SUPERBUILD
+      AND DEFINED Slicer_HOME
+      AND DEFINED Slicer_INSTALL_QTLOADABLEMODULES_INCLUDE_DIR)
+    list(APPEND MODULEQTLIBRARY_INCLUDE_DIRECTORIES
+      "${Slicer_HOME}/${Slicer_INSTALL_QTLOADABLEMODULES_INCLUDE_DIR}"
+      )
+  endif()
+
   # --------------------------------------------------------------------------
   # Set <MODULEQTLIBRARY_NAME>_INCLUDE_DIRS
   # --------------------------------------------------------------------------
-- 
2.52.0

